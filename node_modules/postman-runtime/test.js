const runtime = require('.'),
    sdk = require('postman-collection');
var runner = new runtime.Runner(), // runtime = require('postman-runtime');

    // a collection object constructed using the Postman Collection SDK.
    collection = new sdk.Collection(require('./col.json'));
var tc = require('tough-cookie');

function RequestJar (store) {
    var self = this;

    self._jar = new tc.CookieJar(store, {
        rejectPublicSuffixes: false,
        looseMode: true
    });
}
RequestJar.prototype.setCookie = function (cookieOrStr, uri, options) {
    var self = this;

    return self._jar.setCookieSync(cookieOrStr, uri, options || {});
};
RequestJar.prototype.getCookieString = function (uri) {
    var self = this;

    return self._jar.getCookieStringSync(uri);
};
RequestJar.prototype.getCookies = function (uri) {
    var self = this;

    return self._jar.getCookiesSync(uri);
};

var jar = new RequestJar();

runner.run(collection, {
    fileResolver: require('fs'),
    iterationCount: 2,
    // stopOnError: true,
    // certificates: new sdk.CertificateList({}, [{
    //     id: 1,
    //     cert: {
    //         src: '/Users/udit/Code/postman-runtime/test/integration-legacy/data/server-crt.pem'
    //     },
    //     matches: ['https://www.google.com/*']
    // }]),
    requester: {
        extendedRootCA: '/Users/udit/Desktop/temp/ssl3/all-ca.pem',
        cookieJar: jar
    }
}, function (err, run) {
    run.start({
        // Called any time we see a new assertion in the test scripts
        assertion: function (cursor, assertions) {
            console.log('-> assertion', assertions);
            // cursor = {
            //     position: Number,
            //     iteration: Number,
            //     length: Number,
            //     cycles: Number,
            //     eof: Boolean,
            //     empty: Boolean,
            //     bof: Boolean,
            //     cr: Boolean,
            //     ref: String,
            //     scriptId: String,
            //     eventId: String
            // }

            // assertions: array of assertion objects
            // assertion: {
            //     error: Error,
            //     index: Number,
            //     name: String,
            //     skipped: Number,
            //     passed: Number
            // }
        },

        // Called when the run begins
        start: function (err, cursor) {
            console.log('-> start');
            // err: null or Error
            // cursor = {
            //     position: Number,
            //     iteration: Number,
            //     length: Number,
            //     cycles: Number,
            //     eof: Boolean,
            //     empty: Boolean,
            //     bof: Boolean,
            //     cr: Boolean,
            //     ref: String
            // }
        },

        // Called before starting a new iteration
        beforeIteration: function (err, cursor) {
            console.log('-> beforeIteration');

            /* Same as arguments for "start" */
        },

        // Called when an iteration is completed
        iteration: function (err, cursor) {
            console.log('-> iteration');

            /* Same as arguments for "start" */
        },

        // Called before running a new Item (check the postman collection v2 format for what Item means)
        beforeItem: function (err, cursor, item) {
            console.log('-> beforeItem', `[* ${item.name} *]`);
            // err, cursor: Same as arguments for "start"
            // item: sdk.Item
        },

        // Called after completion of an Item
        item: function (err, cursor, item) {
            console.log('-> item');

            /* Same as arguments for "beforeItem" */
        },

        // Called before running pre-request script(s) (Yes, Runtime supports multiple pre-request scripts!)
        beforePrerequest: function (err, cursor, events, item) {
            // console.log('-> beforePrerequest')
            // setTimeout(() => {
            // console.log('yo')
            // run.host.dispose()
            // run.abort()
            // }, 1000);
            // err, cursor: Same as arguments for "start"
            // events: Array of sdk.Event objects
            // item: sdk.Item
        },

        beforeScript: function (err, cursor, events, item) {
            console.log('-> beforeScript');
        },

        script: function (err, cursor, events, item) {
            console.log('-> script');
        },

        // Called after running pre-request script(s)
        prerequest: function (err, cursor, results, item) {
            console.log('-> prerequest');
            // err, cursor: Same as arguments for "start"
            // item: sdk.Item

            // results: Array of objects. Each object looks like this:
            //  {
            //      error: Error,
            //      event: sdk.Event,
            //      script: sdk.Script,
            //      result: {
            //          target: 'prerequest'
            //
            //          -- Updated environment
            //          environment: <VariableScope>
            //
            //          -- Updated globals
            //          globals: <VariableScope>
            //
            //          data: <Object of data variables>
            //          return: <Object, contains set next request params, etc>
            //      }
            //  }
        },

        // Called before running test script(s)
        beforeTest: function (err, cursor, events, item) {
            console.log('-> beforeTest');
            // err, cursor: Same as arguments for "start"
            // events: Array of sdk.Event objects
            // item: sdk.Item
        },

        // Called just after running test script (s)
        test: function (err, cursor, results, item) {
            console.log('-> test');
            // results: Array of objects. Each object looks like this:
            //  {
            //      error: Error,
            //      event: sdk.Event,
            //      script: sdk.Script,
            //      result: {
            //          target: 'test'
            //
            //          -- Updated environment
            //          environment: <VariableScope>
            //
            //          -- Updated globals
            //          globals: <VariableScope>
            //
            //          response: <sdk.Response>
            //          request: <sdk.Request>
            //          data: <Object of data variables>
            //          cookies: <Array of "sdk.Cookie" objects>
            //          tests: <Object>
            //          return: <Object, contains set next request params, etc>
            //      }
            //  }
        },

        // Called just before sending a request
        beforeRequest: function (err, cursor, request, item) {
            console.log('-> beforeRequest');
            // err, cursor: Same as arguments for "start"
            // item: sdk.Item

            // request: sdk.request
        },

        // Called just after sending a request, may include request replays
        request: function (err, cursor, response, request, item, cookies) {
            console.log('-> request', err);
            // err, cursor: Same as arguments for "start"
            // item: sdk.Item

            // response: sdk.Response
            // request: sdk.request
        },

        // Called once with response for each request in a collection
        response: function (err, cursor, response, request, item, cookies) {
            console.log('-> response');
            // err, cursor: Same as arguments for "start"
            // item: sdk.Item

            // response: sdk.Response
            // request: sdk.request
        },

        exception: function (cursor, err) {
            console.log('-> exception');
            // Called when an exception occurs
            // @param {Object} cursor - A representation of the current run state.
            // @param {Error} err - An Error instance with name, message, and type properties.
        },

        // Called at the end of a run
        done: function (err) {
            console.log('-> done', err);
            // err: null or Error
        },

        // Called any time a console.* function is called in test/pre-request scripts
        console: function (cursor, level, ...logs) {
            console.log('-> console', logs);
        },

        io: function (err, cursor, trace, ...otherArgs) {
            console.log('-> io');
            // err, cursor: Same as arguments for "start"
            // trace: An object which looks like this:
            // {
            //     -- Indicates the type of IO event, may be HTTP, File, etc. Any requests sent out as a part of
            //     -- auth flows, replays, etc will show up here.
            //     type: 'http',
            //
            //     -- Indicates what this IO event originated from, (collection, auth flows, etc)
            //     source: 'collection'
            // }
            // otherArgs: Variable number of arguments, specific to the type of the IO event.

            // For http type, the otherArgs are:
            // response: sdk.Response()
            // request: sdk.Request()
            // cookies: Array of sdk.Cookie()
        }
    });
});
